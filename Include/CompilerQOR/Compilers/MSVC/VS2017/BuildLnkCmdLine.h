//BuildLnkCmdLine.h

// Copyright Querysoft Limited 2017
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.


//Definitions needed to construct an MSVC 2017 linker command line

#define QOR_PP_BUILD_LINK_OPT_SWITCH_PRE				/

//Named switches
//	error report
#define QOR_PP_BUILD_LINK_ERROR_REPORT_OPTS				( 4, ( none , prompt , queue , send ) )
#define QOR_PP_BUILD_LINK_ERROR_REPORT_SELECT_DEF		1
#ifndef QOR_PP_BUILD_LINK_ERROR_REPORT_SELECT
#	define QOR_PP_BUILD_LINK_ERROR_REPORT_SELECT		QOR_PP_BUILD_LINK_ERROR_REPORT_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_ERROR_REPORT_OPT				QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_ERROR_REPORT_SELECT, QOR_PP_BUILD_LINK_ERROR_REPORT_OPTS )

//	subsystem
#define QOR_PP_BUILD_LINK_SUBSYSTEM_OPTS				( 10, ( BOOT_APPLICATION, CONSOLE, EFI_APPLICATION, EFI_BOOT_SERVICE_DRIVER, EFI_ROM, EFI_RUNTIME_DRIVER, NATIVE, POSIX, WINDOWS, WINDOWSCE ) )
#define QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT_DEF			1
#ifndef QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT
#	define QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT			QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_SUBSYSTEM_OPT					QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT, QOR_PP_BUILD_LINK_SUBSYSTEM_OPTS )
#define QOR_PP_BUILD_LINK_EXE_SUBSYSTEM_OPT				QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_SUBSYSTEM_SELECT, QOR_PP_BUILD_LINK_SUBSYSTEM_OPTS )

//	machine
#define QOR_PP_BUILD_LINK_MACHINE_OPTS					( 11, ( X86, X64, THUMB, SH4, MIPS, MIPS16, MIPSFPU, MIPS16FPU, IA64, EBC, ARM ) )
#define QOR_PP_BUILD_LINK_MACHINE_SELECT_DEF			0
#ifndef QOR_PP_BUILD_LINK_MACHINE_SELECT
#	define QOR_PP_BUILD_LINK_MACHINE_SELECT				QOR_PP_BUILD_LINK_MACHINE_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_MACHINE_OPT					QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_MACHINE_SELECT, QOR_PP_BUILD_LINK_MACHINE_OPTS )

//	tlid
#define QOR_PP_BUILD_LINK_TLID_OPTS						( 1, ( 1 ) )
#define QOR_PP_BUILD_LINK_TLID_SELECT_DEF				0
#ifndef QOR_PP_BUILD_LINK_TLID_SELECT
#	define QOR_PP_BUILD_LINK_TLID_SELECT				QOR_PP_BUILD_LINK_TLID_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_TLID_OPT						QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_TLID_SELECT, QOR_PP_BUILD_LINK_TLID_OPTS )

#define QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( _X, _NAME )	QOR_PP_IF( QOR_PP_IS_EMPTY( QOR_PP_EXPAND( _NAME ) ), QOR_PP_EMPTY(), QOR_PP_CAT( QOR_PP_CAT(QOR_PP_BUILD_LINK_OPT_SWITCH_PRE, _X), QOR_PP_CAT(:,_NAME) ) )
#define QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( _X )			QOR_PP_IF( QOR_PP_IS_EMPTY( _X ), QOR_PP_EMPTY(), QOR_PP_CAT( QOR_PP_BUILD_LINK_OPT_SWITCH_PRE, _X ) )

#define QOR_PP_BUILD_LINK_MAKE_IMPLIB_NAME( _MODULENAME ) \
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_BUILD_DIR, QOR_PP_CONFIG_INT_DIR ), _MODULENAME ), .lib ) )

#define QOR_PP_BUILD_LINK_MAKE_PDB_NAME( _MODULENAME ) \
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_BUILD_DIR, QOR_PP_CONFIG_OBJ_DIR ), _MODULENAME ), .pdb ) )

#define QOR_PP_BUILD_LINK_MAKE_PGD_NAME( _MODULENAME ) \
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_BUILD_DIR, QOR_PP_CONFIG_OBJ_DIR ), _MODULENAME ), .pgd ) )

#define QOR_PP_BUILD_LINK_SWITCHES_NAMED(_MODULENAME)	QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( ErrorReport, QOR_PP_BUILD_LINK_ERROR_REPORT_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( SubSystem, QOR_PP_BUILD_LINK_SUBSYSTEM_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( Machine, QOR_PP_BUILD_LINK_MACHINE_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( TLBID, QOR_PP_BUILD_LINK_TLID_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( IMPLIB, QOR_PP_BUILD_LINK_MAKE_IMPLIB_NAME(_MODULENAME) ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( PDB, QOR_PP_BUILD_LINK_MAKE_PDB_NAME(_MODULENAME) )
//QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( PGD, QOR_PP_BUILD_LINK_MAKE_PGD_NAME(_MODULENAME) )

#define QOR_PP_BUILD_LINK_EXE_SWITCHES_NAMED(_MODULENAME)\
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( ErrorReport, QOR_PP_BUILD_LINK_ERROR_REPORT_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( SubSystem, QOR_PP_BUILD_LINK_EXE_SUBSYSTEM_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( Machine, QOR_PP_BUILD_LINK_MACHINE_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( TLBID, QOR_PP_BUILD_LINK_TLID_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( PDB, QOR_PP_BUILD_LINK_MAKE_PDB_NAME(_MODULENAME) )


#define QOR_PP_BUILD_LINK_MAKE_DLL_NAME( _MODULENAME ) \
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_BUILD_DIR, QOR_PP_CONFIG_INT_DIR ), _MODULENAME ), .dll ) )

#define QOR_PP_BUILD_LINK_MAKE_EXE_NAME( _MODULENAME ) \
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_BUILD_DIR, QOR_PP_CONFIG_INT_DIR ), _MODULENAME ), .exe ) )
//Output
#define QOR_PP_BUILD_LINK_SWITCHES_OUTPUT(_MODULENAME)	QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( OUT, QOR_PP_BUILD_LINK_MAKE_DLL_NAME(_MODULENAME) )
#define QOR_PP_BUILD_LINK_EXE_SWITCHES_OUTPUT(_MODULENAME)\
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( OUT, QOR_PP_BUILD_LINK_MAKE_EXE_NAME(_MODULENAME) )

//Simple
//	incremental
#define QOR_PP_BUILD_LINK_INCREMENTAL_OPTS				( 2, ( QOR_PP_EMPTY(), INCREMENTAL ) )
#define QOR_PP_BUILD_LINK_INCREMENTAL_SELECT_DEF		1
#ifndef QOR_PP_BUILD_LINK_INCREMENTAL_SELECT
#	define QOR_PP_BUILD_LINK_INCREMENTAL_SELECT			QOR_PP_BUILD_LINK_INCREMENTAL_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_INCREMENTAL_OPT				QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_INCREMENTAL_SELECT, QOR_PP_BUILD_LINK_INCREMENTAL_OPTS )

//	nologo
#define QOR_PP_BUILD_LINK_NOLOGO_OPTS					( 2, ( QOR_PP_EMPTY(), NOLOGO ) )
#define QOR_PP_BUILD_LINK_NOLOGO_SELECT_DEF				1
#ifndef QOR_PP_BUILD_LINK_NOLOGO_SELECT
#	define QOR_PP_BUILD_LINK_NOLOGO_SELECT				QOR_PP_BUILD_LINK_NOLOGO_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_NOLOGO_OPT					QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_NOLOGO_SELECT, QOR_PP_BUILD_LINK_NOLOGO_OPTS )

//	nodefaultlib
#define QOR_PP_BUILD_LINK_NODEFAULTLIB_OPTS				( 2, ( QOR_PP_EMPTY(), NODEFAULTLIB ) )
#define QOR_PP_BUILD_LINK_NODEFAULTLIB_SELECT_DEF		1
#ifndef QOR_PP_BUILD_LINK_NODEFAULTLIB_SELECT
#	define QOR_PP_BUILD_LINK_NODEFAULTLIB_SELECT		QOR_PP_BUILD_LINK_NODEFAULTLIB_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_NODEFAULTLIB_OPT				QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_NODEFAULTLIB_SELECT, QOR_PP_BUILD_LINK_NODEFAULTLIB_OPTS )

//	debug
#define QOR_PP_BUILD_LINK_DEBUG_OPTS					( 2, ( QOR_PP_EMPTY(), DEBUG ) )
#define QOR_PP_BUILD_LINK_DEBUG_SELECT_DEF				1
#ifndef QOR_PP_BUILD_LINK_DEBUG_SELECT
#	define QOR_PP_BUILD_LINK_DEBUG_SELECT				QOR_PP_BUILD_LINK_DEBUG_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_DEBUG_OPT						QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_DEBUG_SELECT, QOR_PP_BUILD_LINK_DEBUG_OPTS )

//	dynamicbase
#define QOR_PP_BUILD_LINK_DYNAMICBASE_OPTS				( 2, ( QOR_PP_EMPTY(), DYNAMICBASE ) )
#define QOR_PP_BUILD_LINK_DYNAMICBASE_SELECT_DEF		1
#ifndef QOR_PP_BUILD_LINK_DYNAMICBASE_SELECT
#	define QOR_PP_BUILD_LINK_DYNAMICBASE_SELECT			QOR_PP_BUILD_LINK_DYNAMICBASE_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_DYNAMICBASE_OPT				QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_DYNAMICBASE_SELECT, QOR_PP_BUILD_LINK_DYNAMICBASE_OPTS )

//	nxcompat
#define QOR_PP_BUILD_LINK_NXCOMPAT_OPTS					( 2, ( QOR_PP_EMPTY(), NXCOMPAT ) )
#define QOR_PP_BUILD_LINK_NXCOMPAT_SELECT_DEF			1
#ifndef QOR_PP_BUILD_LINK_NXCOMPAT_SELECT
#	define QOR_PP_BUILD_LINK_NXCOMPAT_SELECT			QOR_PP_BUILD_LINK_NXCOMPAT_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_NXCOMPAT_OPT					QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_NXCOMPAT_SELECT, QOR_PP_BUILD_LINK_NXCOMPAT_OPTS )

//	dll
#define QOR_PP_BUILD_LINK_DLL_OPTS						( 2, ( QOR_PP_EMPTY(), DLL ) )
#define QOR_PP_BUILD_LINK_DLL_SELECT_DEF				1
#ifndef QOR_PP_BUILD_LINK_DLL_SELECT
#	define QOR_PP_BUILD_LINK_DLL_SELECT					QOR_PP_BUILD_LINK_DLL_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_DLL_OPT						QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_DLL_SELECT, QOR_PP_BUILD_LINK_DLL_OPTS )


#define QOR_PP_BUILD_LINK_SWITCHES_SIMPLE				QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_INCREMENTAL_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NOLOGO_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NODEFAULTLIB_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_DEBUG_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_DYNAMICBASE_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NXCOMPAT_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_DLL_OPT )

#define QOR_PP_BUILD_LINK_EXE_SWITCHES_SIMPLE			QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_INCREMENTAL_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NOLOGO_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NODEFAULTLIB_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_DEBUG_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_NXCOMPAT_OPT )
//Manifest
//	manifest
#define QOR_PP_BUILD_LINK_MANIFEST_OPTS					( 2, ( QOR_PP_EMPTY(), MANIFEST ) )
#define QOR_PP_BUILD_LINK_MANIFEST_SELECT_DEF			1
#ifndef QOR_PP_BUILD_LINK_MANIFEST_SELECT
#	define QOR_PP_BUILD_LINK_MANIFEST_SELECT			QOR_PP_BUILD_LINK_MANIFEST_SELECT_DEF
#endif
#define QOR_PP_BUILD_LINK_MANIFEST_OPT					QOR_PP_ARRAY_ELEM( QOR_PP_BUILD_LINK_MANIFEST_SELECT, QOR_PP_BUILD_LINK_MANIFEST_OPTS )

#define QOR_PP_BUILD_LINK_MANIFEST_INTERMEDIATE( _MODULE_NAME )	\
														QOR_PP_STRINGIZE( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CONFIG_INT_DIR,_MODULE_NAME ), .dll.intermediate.manifest ) )

#define QOR_PP_BUILD_LINK_SWITCHES_MANIFEST(_MODULE_NAME) \
														QOR_PP_BUILD_LINK_MAKE_SIMPLE_OPT( QOR_PP_BUILD_LINK_MANIFEST_OPT ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( ManifestFile, QOR_PP_BUILD_LINK_MANIFEST_INTERMEDIATE( _MODULE_NAME ) ) \
														QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( MANIFESTUAC, "level='asInvoker' uiAccess='false'" ) /*\
														QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CAT( QOR_PP_CONFIG_INT_DIR, QOR_MODULE_NAME ), .dll ), .embed.manifest.res )*/

#define QOR_PP_BUILD_LINK_SWITCHES_ALL(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINK_SWITCHES_NAMED(_MODULE_NAME) \
														QOR_PP_BUILD_LINK_SWITCHES_OUTPUT(_MODULE_NAME) \
														QOR_PP_BUILD_LINK_SWITCHES_SIMPLE \
														QOR_PP_SEQ_FOR_EACH_I( QOR_PP_BUILD_LINK_MAKE_LIBPATH, _, _LIBPATHS_SEQUENCE ) \
														QOR_PP_SEQ_FOR_EACH_I( QOR_PP_BUILD_LINK_MAKE_LIB, _, _LIBS_SEQUENCE ) \
														QOR_PP_CAT( _MODULE_NAME, .exp ) \
														QOR_PP_BUILD_LINK_SWITCHES_MANIFEST(_MODULE_NAME)

#define QOR_PP_BUILD_LINK_EXE_SWITCHES_ALL(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINK_EXE_SWITCHES_NAMED(_MODULE_NAME) \
														QOR_PP_BUILD_LINK_EXE_SWITCHES_OUTPUT(_MODULE_NAME) \
														QOR_PP_BUILD_LINK_EXE_SWITCHES_SIMPLE \
														QOR_PP_SEQ_FOR_EACH_I( QOR_PP_BUILD_LINK_MAKE_LIBPATH, _, _LIBPATHS_SEQUENCE ) \
														QOR_PP_SEQ_FOR_EACH_I( QOR_PP_BUILD_LINK_MAKE_LIB, _, _LIBS_SEQUENCE ) \
														QOR_PP_BUILD_LINK_SWITCHES_MANIFEST(_MODULE_NAME)

#define QOR_PP_BUILD_LINK_OPTIONS(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINK_SWITCHES_ALL(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME)

#define QOR_PP_BUILD_LINK_EXE_OPTIONS(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINK_EXE_SWITCHES_ALL(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME)


#define QOR_PP_BUILD_LINK_MAKE_OBJ( r, _EXT, _IGNORE, _OBJ ) QOR_PP_CAT( _OBJ,_EXT )
#define QOR_PP_BUILD_LINK_MAKE_LIBPATH( r, _IG1, _IG2, _PATH ) QOR_PP_BUILD_LINK_MAKE_NAMED_OPT( LibPath, QOR_PP_STRINGIZE( _PATH ) )
#define QOR_PP_BUILD_LINK_MAKE_LIB( r, _IG1, _IG2, _NAME ) QOR_PP_STRINGIZE( QOR_PP_CAT( _NAME,.lib ) )

#define QOR_PP_BUILD_LINK_COMMAND_LINE(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _OBJS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINKER_EXECUTABLE QOR_PP_BUILD_LINK_OPTIONS(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_SEQ_FOR_EACH_I( QOR_PP_BUILD_LINK_MAKE_OBJ, .o, _OBJS_SEQUENCE )

#define QOR_PP_BUILD_LINK_COMMAND_LINE2(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINKER_EXECUTABLE QOR_PP_BUILD_LINK_OPTIONS(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_CAT( @,QOR_PP_BUILD_LINK_OBJLISTNAME( _MODULE_NAME ) )

#define QOR_PP_BUILD_LINK_COMMAND_LINE3(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_BUILD_LINKER_EXECUTABLE QOR_PP_BUILD_LINK_EXE_OPTIONS(_LIBPATHS_SEQUENCE, _LIBS_SEQUENCE, _MODULE_NAME) \
														QOR_PP_CAT( @,QOR_PP_BUILD_LINK_OBJLISTNAME( _MODULE_NAME ) )
