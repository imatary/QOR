//WinQLDisplay.h

// Copyright Querysoft Limited 2013
//
// Permission is hereby granted, free of charge, to any person or organization
// obtaining a copy of the software and accompanying documentation covered by
// this license (the "Software") to use, reproduce, display, distribute,
// execute, and transmit the Software, and to prepare derivative works of the
// Software, and to permit third-parties to whom the Software is furnished to
// do so, all subject to the following:
// 
// The copyright notices in the Software and this entire statement, including
// the above license grant, this restriction and the following disclaimer,
// must be included in all copies of the Software, in whole or in part, and
// all derivative works of the Software, unless such copies or derivative
// works are solely in the form of machine-executable object code generated by
// a source language processor.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
// SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
// FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
// ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.

#ifndef WINQL_GRAPHICS_DISPLAY_H_3
#define WINQL_GRAPHICS_DISPLAY_H_3

#ifdef	__QCMP_OPTIMIZEINCLUDE
#pragma	__QCMP_OPTIMIZEINCLUDE
#endif//__QCMP_OPTIMIZEINCLUDE

#include "WinQL/Definitions/Handles.h"
#include "WinQL/GUI/Desktop.h"
#include "WinQL/Application/Graphics/WinQLRectangle.h"
#include "WinQL/GUI/Window.h"
#include "CodeQOR/DataStructures/TRef.h"

__QOR_DECLARE_REF(nsWin32, __WINQL, CDisplayDevice, CTRef);
__QOR_DECLARE_REF(nsWin32, __WINQL, CDisplayMonitor, CTRef);

//--------------------------------------------------------------------------------
namespace nsWin32
{
	//--------------------------------------------------------------------------------
	typedef struct _DISPLAY_DEVICE 
	{
		unsigned long cb;
		TCHAR DeviceName[ 32 ];
		TCHAR DeviceString[ 128 ];
		unsigned long StateFlags;
		TCHAR DeviceID[ 128 ];
		TCHAR DeviceKey[ 128 ];
	} DISPLAY_DEVICE, *PDISPLAY_DEVICE, *LPDISPLAY_DEVICE;

	//--------------------------------------------------------------------------------
	typedef struct tagMONITORINFO
	{
		unsigned long cbSize;
		RECT rcMonitor;
		RECT rcWork;
		unsigned long dwFlags;
	} MONITORINFO, *LPMONITORINFO;

	typedef int ( __QCMP_STDCALLCONVENTION *MONITORENUMPROC )( void*, void*, nsWin32::RECT*, Cmp_long_ptr );


	//--------------------------------------------------------------------------------
	class __QOR_INTERFACE( __WINQL ) CDisplayHelper
	{
	public:

		__QCMP_STATIC_CONSTANT( int, _EDD_GET_DEVICE_INTERFACE_NAME = 0x00000001 );

		__QOR_DECLARE_OCLASS_ID( CDisplayHelper );

		CDisplayHelper();
		CDisplayHelper(const CDisplayHelper& src);
		CDisplayHelper(CDisplayHelper&& move);
		CDisplayHelper& operator = (const CDisplayHelper& src);
		CDisplayHelper& operator = (CDisplayHelper&& move);
		virtual ~CDisplayHelper();
		long ChangeSettings( nsWin32::LPDEVMODE lpDevMode, unsigned long dwflags ) const;
		long ChangeSettings( const TCHAR* lpszDeviceName, nsWin32::LPDEVMODE lpDevMode, COSWindow::refType Window, unsigned long dwflags, void* lParam ) const;
		bool EnumDevices( const TCHAR* lpDevice, unsigned long iDevNum, nsWin32::PDISPLAY_DEVICE lpDisplayDevice, unsigned long dwFlags ) const;
		bool EnumSettings( const TCHAR* lpszDeviceName, unsigned long iModeNum, nsWin32::LPDEVMODE lpDevMode, unsigned long dwFlags = 0 ) const;
		bool EnumDisplayMonitors( CDeviceContext::refType dc, const nsWin32::RECT* lprcClip, nsWin32::MONITORENUMPROC lpfnEnum, Cmp_long_ptr dwData ) const;
		bool SetProcessDPIAware( void ) const;
		bool GetProcessDefaultLayout( unsigned long* pdwDefaultLayout ) const;
		bool SetProcessDefaultLayout( unsigned long dwDefaultLayout ) const;
		bool IsProcessDPIAware( void ) const;

	private:

		nsWinQAPI::CUser32& m_User32Library;			
	};

	//--------------------------------------------------------------------------------
	class __QOR_INTERFACE( __WINQL ) CMonitorHelper
	{
	public:

		__QOR_DECLARE_OCLASS_ID( CMonitorHelper );

		CMonitorHelper( CMonitorHandle::refType hMonitor );
		CMonitorHelper( const CMonitorHelper& Monitor );		
		CMonitorHelper ( nsWin32::POINT pt, unsigned long dwFlags );
		CMonitorHelper( const nsWin32::RECT* lprc, unsigned long dwFlags );
		CMonitorHelper( COSWindow::refType Window, unsigned long dwFlags );
		virtual ~CMonitorHelper();
		bool GetInfo( nsWin32::LPMONITORINFO lpmi ) const;

	protected:

		CMonitorHandle m_Handle;		

	private:

		nsWinQAPI::CUser32& m_User32Library;

		__QCS_DECLARE_NONASSIGNABLE( CMonitorHelper );
	};

	__QOR_DECLARE_OCLASS_ID(CDisplay);

	//--------------------------------------------------------------------------------
	class __QOR_INTERFACE(__WINQL) CDisplayDevice : public nsWin32::DISPLAY_DEVICE
	{
		friend class CDisplay;

	public:

		__QOR_DECLARE_OCLASS_ID(CDisplayDevice);
		__QOR_DECLARE_REF_TYPE(CDisplayDevice);

		CDisplayDevice();
		CDisplayDevice(const DISPLAY_DEVICE& src);
		CDisplayDevice( const CDisplayDevice& src );
		CDisplayDevice(CDisplayDevice&& move);
		CDisplayDevice& operator=(const CDisplayDevice& Src);
		CDisplayDevice& operator=(CDisplayDevice&& move);
		virtual ~CDisplayDevice();
				
		bool EnumSettings(unsigned long iModeNum, nsWin32::LPDEVMODE lpDevMode, unsigned long dwFlags) const;
		long ChangeSettings(nsWin32::LPDEVMODE lpDevMode, COSWindow::refType Window, unsigned long dwflags, void* lParam) const;
		CTString GetDeviceID(void) const;
		CTString GetDeviceString(void) const;

	private:

		CDisplayHelper m_Win32DisplayHelper;
		bool m_bInitialised;
	};

	//--------------------------------------------------------------------------------
	class __QOR_INTERFACE(__WINQL) CDisplayMonitor : public nsWin32::MONITORINFO
	{
	public:

		__QOR_DECLARE_OCLASS_ID(CDisplayMonitor);
		__QOR_DECLARE_REF_TYPE(CDisplayMonitor);

		CDisplayMonitor() = delete;
		CDisplayMonitor(const CDisplayMonitor& Monitor);
		CDisplayMonitor(CDisplayMonitor&& move);
		CDisplayMonitor(CMonitorHandle::refType hMonitor);
		CDisplayMonitor(nsWin32::POINT pt, unsigned long dwFlags);
		CDisplayMonitor(const CRectangle* lprc, unsigned long dwFlags);
		CDisplayMonitor(COSWindow::refType Window, unsigned long dwFlags);
		CDisplayMonitor& operator = (const CDisplayMonitor& src);
		CDisplayMonitor& operator = (CDisplayMonitor&& move);
		bool IsPrimary(void) const;
		virtual ~CDisplayMonitor();

	protected:

		CMonitorHelper m_Win32Monitor;
	};

	//--------------------------------------------------------------------------------
	class __QOR_INTERFACE( __WINQL ) CDisplay
	{

	public:

		__QOR_DECLARE_OCLASS_ID(CDisplay);

		CDisplay();
		CDisplay(const CDisplay&) = delete;
		CDisplay(CDisplay&& move);
		CDisplay& operator = (const CDisplay&) = delete;
		CDisplay& operator = (CDisplay&& move);
		~CDisplay();

		CDisplayDevice::ref_type DefaultDevice( void );
		std::vector< CDisplayDevice::ref_type >::iterator Devices_begin(void);
		std::vector< CDisplayDevice::ref_type >::iterator Devices_end(void);
		std::vector< CDisplayMonitor::ref_type >::iterator Monitors_begin(void);
		std::vector< CDisplayMonitor::ref_type >::iterator Monitors_end(void);
		CDisplayMonitor::ref_type MonitorFromPoint( nsWin32::POINT pt, unsigned long dwFlags );
		CDisplayMonitor::ref_type MonitorFromRect( const CRectangle* lprc, unsigned long dwFlags );
		CDisplayMonitor::ref_type MonitorFromWindow( COSWindow::refType Window, unsigned long dwFlags );

		long ChangeSettingsForDefaultDevice( nsWin32::LPDEVMODE lpDevMode, unsigned long dwflags );
		bool EnumMonitors( CDeviceContext::refType dc, const CRectangle* lprcClip, nsWin32::MONITORENUMPROC lpfnEnum, Cmp_long_ptr dwData );

	private:

		bool EnumDevices();
		bool EnumAllMonitors();
		static bool __QCMP_STDCALLCONVENTION EnumMonitorProc( void* hMonitor, void* hdcMonitor, nsWin32::LPRECT lprcMonitor, Cmp_long_ptr dwData );
		bool AddMonitor( void* hMonitor, CDeviceContext::refType dcMonitor, nsWin32::LPRECT lprcMonitor );

		bool m_bDevicesEnumerated;
		bool m_bMonitorsEnumerated;
		std::vector< CDisplayDevice::ref_type > m_Devices;
		std::vector< CDisplayMonitor::ref_type > m_Monitors;
		CDisplayHelper m_Win32DisplayHelper;

	};

}//nsWin32

#endif//WINQL_GRAPHICS_DISPLAY_H_3
